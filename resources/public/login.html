
<!DOCTYPE html>
<html>
  <head>
    <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Login to Linkletter</title>
    <script src="/assets/jquery/jquery.min.js" type="text/javascript"></script>
    <script src="/assets/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="//connect.facebook.net/en_US/sdk.js" type="text/javascript"></script>
    <script src="js/handlebars.js" type="text/javascript"></script>
  </head>
  <body>

    <div class="container">
      <div class="row">

        <form class="form-signin">

          <div id="status">
          </div>
        </form>
        <button id="fb-login" class="btn btn-primary btn-block" type="submit">Login with Facebook</button>

      </div> <!-- /container -->



      <!-- scripts and styles -->
      <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css">
      <link rel="stylesheet" href="/assets/bootstrap/css/bootstrap-theme.min.css"> 
      <link rel="stylesheet" href="css/main.css"/>

      <script>

// Load the SDK asynchronously
/*(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));*/

function handleFbStatus(response){
  console.log('inside handleFbStatus ' + JSON.stringify(response));
  if(response.status == 'connected'){

    submitResponse(response);
    //get user deatails and access token
    FB.api('/me', function(response){
      console.log("logged in: ", JSON.stringify(response));
    });
    //window.location.href = "/login2.html";
  }else if(response.status == 'not_authorized' || response.status == 'unknown'){
    FB.login(function(response) {
      if (response.status === 'connected') {
        // Logged into your app and Facebook.
        console.log('connected: ' + JSON.stringify(response));
        submitResponse(response);
      } else if (response.status === 'not_authorized') {
        // The person is logged into Facebook, but not your app.
        console.log('not authorized ' + JSON.stringify(response));
      } else {
        // The person is not logged into Facebook, so we're not sure if
        // they are logged into this app or not.
        console.log('not logged in' + JSON.stringify(response));

      }
    },{scope: 'email'});
  }
}

function handleLoginResponse(res){
  //console.log(JSON.stringify(res));
  if(!res.error){
    //window.location.href="login2.html";
  }
}

function submitResponse(response){
    //send response, 
    // on successful account creation/ authentication of user redirect user to links page
  response.authResponse.loginType = "FB";
  $.ajax({
    method: "POST",
    url: "/login",
    data: response.authResponse
  })
  .done(handleLoginResponse)
    .fail(function(){
      console.log('Error in logggin in, please try again');
    });
}
        

$(document).ready(function(){
// This is called with the results from from FB.getLoginStatus().
window.fbAsyncInit = function() {
  FB.init({
    appId      : '826503424132665',
    cookie     : true,  // enable cookies to allow the server to access 
    // the session
    xfbml      : false,  // parse social plugins on this page
    version    : 'v2.2' // use version 2.2
  });
};

  FB.getLoginStatus(function(response) {
    statusChangeCallback(response);
  });
  $("#fb-login").click(function(e){
    e.preventDefault();
    console.log('login button clicked');
    FB.getLoginStatus(handleFbStatus);
  });
});
      </script>
  </body>
</html>


